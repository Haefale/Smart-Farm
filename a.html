<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Farm Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #1a1a1a;
            color: #ffffff;
            text-align: center;
        }
        .header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        .data-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .data-box {
            background-color: #333333;
            border-radius: 10px;
            padding: 15px;
            width: 45%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }
        .data-label {
            font-size: 14px;
            color: #cccccc;
            margin-bottom: 5px;
        }
        .data-value {
            font-size: 32px;
            font-weight: bold;
            color: #66ccff;
        }
        .threshold-value {
            color: #ff9933;
            font-size: 28px;
        }
        .control-section {
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        .control-header {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .control-button {
            padding: 12px 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            flex-grow: 1;
            transition: background-color 0.3s;
        }
        .system-manual-btn {
            background-color: #5cb85c;
            color: white;
        }
        .system-manual-btn.active {
            background-color: #d9534f;
        }
        .pump-control-btn {
            background-color: #5bc0de;
            color: white;
        }
        .led-control-btn {
            background-color: #f0ad4e;
            color: white;
        }
        .threshold-set-btn {
            background-color: #ff9933;
            color: white;
        }
        .ble-connect-btn {
            background-color: #00e676;
            color: #1a1a1a;
        }
        .ble-disconnect-btn {
            background-color: #ff5252;
            color: white;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-auto { background-color: #5cb85c; color: white; }
        .status-manual { background-color: #d9534f; color: white; }
        .status-on { background-color: #007bff; color: white; }
        .status-off { background-color: #6c757d; color: white; }
        .status-ble-connecting { background-color: #007bff; color: white; }
        .status-ble-connected { background-color: #00e676; color: #1a1a1a; }
        .status-ble-disconnected { background-color: #ff5252; color: white; }
        #bleDeviceList {
            background-color: #1c1c1c;
            border: 1px solid #424242;
            border-radius: 4px;
            margin-top: 10px;
            padding: 5px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
            font-size: 14px;
            color: #9e9e9e;
        }
        #bleDeviceList div {
            padding: 8px 5px;
            border-bottom: 1px dashed #2a2a2a;
            cursor: pointer;
        }
        .threshold-input {
            width: 70px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: #fff;
            font-size: 16px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="header">Smart Farm Dashboard</div>

<div class="data-container">
    <div class="data-box">
        <div class="data-label">토양 습도</div>
        <div id="soilMoistureValue" class="data-value">-- %</div>
    </div>
    <div class="data-box">
        <div class="data-label">조도 값</div>
        <div id="lightValue" class="data-value">--</div>
    </div>
    <div class="data-box">
        <div class="data-label">습도 임계값</div>
        <div id="humidityThresholdValue" class="data-value threshold-value">-- %</div>
    </div>
    <div class="data-box">
        <div class="data-label">조도 임계값</div>
        <div id="lightThresholdValue" class="data-value threshold-value">--</div>
    </div>
</div>

<div class="control-section">
    <div class="control-header">
        시스템 모드
        <span id="systemStatusBadge" class="status-badge status-auto">자동</span>
    </div>
    <div class="button-group">
        <button id="systemManualToggle" class="control-button system-manual-btn" onclick="toggleSystemManualMode()">수동 모드 전환</button>
    </div>

    <div class="control-header">
        펌프 작동 상태
        <span id="pumpStatusBadge" class="status-badge status-off">OFF</span>
    </div>
    <div class="button-group">
        <button class="control-button pump-control-btn" onclick="sendCommand('pump', 'on')">펌프 ON</button>
        <button class="control-button pump-control-btn" onclick="sendCommand('pump', 'off')">펌프 OFF</button>
    </div>

    <div class="control-header">
        LED 작동 상태
        <span id="ledStatusBadge" class="status-badge status-off">OFF</span>
    </div>
    <div class="button-group">
        <button class="control-button led-control-btn" onclick="sendCommand('led', 'on')">LED ON</button>
        <button class="control-button led-control-btn" onclick="sendCommand('led', 'off')">LED OFF</button>
    </div>

    <div class="control-header">임계값 설정</div>
    <div class="button-group">
        <input type="number" id="inputHumidityThreshold" class="threshold-input" min="0" max="90" value="30">
        <button class="control-button threshold-set-btn" onclick="setThreshold('H')">습도 설정</button>
    </div>
    <div class="button-group">
        <input type="number" id="inputLightThreshold" class="threshold-input" min="0" max="1023" value="100">
        <button class="control-button threshold-set-btn" onclick="setThreshold('L')">조도 설정</button>
    </div>
</div>

<div class="control-section" style="background-color: #1c1c1c; border: 1px solid #424242;">
    <div class="control-header" style="color: #66ccff;">
        BLE Connection
        <span id="bleConnectionStatus" class="status-badge status-ble-disconnected">Disconnected</span>
    </div>
    <div class="button-group">
        <button id="btnBleConnect" class="control-button ble-connect-btn" onclick="startScan(true)">Scan & Connect</button>
        <button id="btnBleDisconnect" class="control-button ble-disconnect-btn" onclick="disconnect()">Disconnect</button>
    </div>
    <p id="tvBleInfo" style="font-size: 13px; color: #bdbdbd; margin-top: 5px;">BLE Status: Ready</p>
    <div id="bleDeviceList">
        <div>Click 'Scan & Connect' to find devices.</div>
    </div>
</div>

<script>
    function updateDashboardData(rawData) {
        const dataMap = {};
        try {
            const cleanData = rawData.replace(/%/g, '').trim();
            const parts = cleanData.split(',');
            for (let i = 0; i < parts.length; i += 2) {
                if (i + 1 < parts.length) {
                    dataMap[parts[i].trim()] = parts[i+1].trim();
                }
            }
        } catch (e) {
            return;
        }

        if (dataMap.H !== undefined) document.getElementById('soilMoistureValue').innerText = dataMap.H + " %";
        if (dataMap.L !== undefined) document.getElementById('lightValue').innerText = dataMap.L;
        if (dataMap.HT !== undefined) document.getElementById('humidityThresholdValue').innerText = dataMap.HT + " %";
        if (dataMap.LT !== undefined) document.getElementById('lightThresholdValue').innerText = dataMap.LT;

        const isManual = dataMap.SM === '1';
        const systemBadge = document.getElementById('systemStatusBadge');
        const systemButton = document.getElementById('systemManualToggle');
        
        systemBadge.innerText = isManual ? '수동' : '자동';
        systemBadge.className = isManual ? 'status-badge status-manual' : 'status-badge status-auto';
        systemButton.innerText = isManual ? '자동 모드 전환' : '수동 모드 전환';
        systemButton.classList.toggle('active', isManual);

        const isPumpRunning = dataMap.RP === '1';
        const pumpBadge = document.getElementById('pumpStatusBadge');
        pumpBadge.innerText = isPumpRunning ? 'ON' : 'OFF';
        pumpBadge.className = 'status-badge ' + (isPumpRunning ? 'status-on' : 'status-off');

        let isLedRunning = isManual ? (dataMap.RL === '1') : (dataMap.RL === '0');
        const ledBadge = document.getElementById('ledStatusBadge');
        ledBadge.innerText = isLedRunning ? 'ON' : 'OFF';
        ledBadge.className = 'status-badge ' + (isLedRunning ? 'status-on' : 'status-off');
    }

    function updateBleStatusBadge(statusText, badgeClass) {
        const badge = document.getElementById('bleConnectionStatus');
        badge.innerText = statusText;
        badge.className = 'status-badge ' + badgeClass;
        document.getElementById('tvBleInfo').innerText = "BLE Status: " + statusText;
        document.getElementById('btnBleConnect').disabled = statusText === 'Connected';
    }

    function updateStatus(status) {
        if (status.includes('활성화') || status.includes('기록 없음')) {
            updateBleStatusBadge('Ready', 'status-ble-disconnected');
        } else if (status.includes('스캔 중')) {
            updateBleStatusBadge('Scanning', 'status-ble-connecting');
            document.getElementById('bleDeviceList').innerHTML = '<div>Searching...</div>';
        } else if (status.includes('연결 시도') || status.includes('MTU')) {
            updateBleStatusBadge('Connecting', 'status-ble-connecting');
        } else if (status.includes('연결됨') || status.includes('준비 완료')) {
            updateBleStatusBadge('Connected', 'status-ble-connected');
            document.getElementById('bleDeviceList').innerHTML = '<div>Device Connected. Receiving data...</div>';
        } else {
            updateBleStatusBadge('Disconnected', 'status-ble-disconnected');
        }
    }

    function updateDeviceList(devicesJson) {
        const list = document.getElementById('bleDeviceList');
        list.innerHTML = '';
        let devices = JSON.parse(devicesJson);

        if (devices.length === 0) {
            list.innerHTML = '<div>No devices found.</div>';
            return;
        }

        devices.forEach(device => {
            const item = document.createElement('div');
            item.innerText = `${device.name || 'Unknown'} (${device.address})`;
            item.onclick = () => {
                if (window.AndroidBridge) window.AndroidBridge.connectToDevice(device.address);
                updateBleStatusBadge('Connecting', 'status-ble-connecting');
            };
            list.appendChild(item);
        });
    }

    function updateReceivedData(rawData) {
        updateDashboardData(rawData);
    }

    function sendCommand(target, action) {
        const command = `${target.toUpperCase()}_${action.toUpperCase()}`;
        if (window.AndroidBridge) window.AndroidBridge.sendTextCommand(command);
    }

    function toggleSystemManualMode() {
        const currentMode = document.getElementById('systemStatusBadge').innerText;
        const command = currentMode === '자동' ? 'MANUAL_ON' : 'MANUAL_OFF';
        if (window.AndroidBridge) window.AndroidBridge.sendTextCommand(command);
    }

    function setThreshold(target) {
        const inputId = target === 'H' ? 'inputHumidityThreshold' : 'inputLightThreshold';
        const value = document.getElementById(inputId).value;
        const command = `SET_${target}_${value}`;
        if (window.AndroidBridge) {
            window.AndroidBridge.sendTextCommand(command);
            alert(`Threshold set to ${value}`);
        }
    }

    function startScan(isManual) {
        if (window.AndroidBridge) window.AndroidBridge.startBleScan(isManual);
    }

    function disconnect() {
        if (window.AndroidBridge) window.AndroidBridge.disconnectGatt();
    }

    document.addEventListener('DOMContentLoaded', () => {
        startScan(false);
    });
</script>

</body>
</html>
